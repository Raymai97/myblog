<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Enable Direct3D acceleration in Windows 2000 in VirtualBox (Updated)</title>
  <meta name="description" content="Yes, you read it right. This is done by backporting files for WinXP back to Win2000.">

  <link rel="stylesheet" href="/myblog/assets/main.css">
  <link rel="canonical" href="https://raymai97.github.io/myblog/enable-direct3d-in-win2k-vbox">
  <link rel="alternate" type="application/rss+xml" title="myblog - raymai97" href="/myblog/feed.xml">
  
  
  
  <!-- Begin Jekyll SEO tag v2.7.1 -->
<title>Enable Direct3D acceleration in Windows 2000 in VirtualBox (Updated) | myblog - raymai97</title>
<meta name="generator" content="Jekyll v4.2.0" />
<meta property="og:title" content="Enable Direct3D acceleration in Windows 2000 in VirtualBox (Updated)" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Yes, you read it right. This is done by backporting files for WinXP back to Win2000." />
<meta property="og:description" content="Yes, you read it right. This is done by backporting files for WinXP back to Win2000." />
<link rel="canonical" href="https://raymai97.github.io/myblog/enable-direct3d-in-win2k-vbox" />
<meta property="og:url" content="https://raymai97.github.io/myblog/enable-direct3d-in-win2k-vbox" />
<meta property="og:site_name" content="myblog - raymai97" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2021-08-29T13:42:00+08:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Enable Direct3D acceleration in Windows 2000 in VirtualBox (Updated)" />
<script type="application/ld+json">
{"@type":"BlogPosting","headline":"Enable Direct3D acceleration in Windows 2000 in VirtualBox (Updated)","dateModified":"2021-08-29T13:42:00+08:00","datePublished":"2021-08-29T13:42:00+08:00","description":"Yes, you read it right. This is done by backporting files for WinXP back to Win2000.","url":"https://raymai97.github.io/myblog/enable-direct3d-in-win2k-vbox","mainEntityOfPage":{"@type":"WebPage","@id":"https://raymai97.github.io/myblog/enable-direct3d-in-win2k-vbox"},"@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->

</head>
<body><header class="site-header" role="banner">

  <div class="wrapper"><a class="site-title" rel="author" href="/myblog/">myblog - raymai97</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/myblog/about/">About</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Enable Direct3D acceleration in Windows 2000 in VirtualBox (Updated)</h1>
    <p class="post-meta">
      <time class="dt-published" datetime="2021-08-29T13:42:00+08:00" itemprop="datePublished">Aug 29, 2021
      </time></p>
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    <p>Yes, you read it right. This is done by backporting files for WinXP back to Win2000.</p>

<p>I have tested this on VirtualBox versions below:</p>
<ul>
  <li>v5.0.10.r104061 (… in 2017, <a href="https://raymai97.github.io/myblog_archived/enable-direct3d-in-win2k-vbox">see archived post here</a>)</li>
  <li>v5.2.44.r139111 (Thanks to Nicolas for prompting me to update this)</li>
</ul>

<h2 id="part-0-a-few-notes">Part 0: A few notes</h2>

<ul>
  <li>
    <p>Win2000 refers to “Windows 2000 Professional with SP4”. I didn’t test on earlier version of Win2000.</p>
  </li>
  <li>
    <p>WinXP refers to “32-bit Windows XP Professional with SP3”. I didn’t test on earlier version of WinXP.</p>
  </li>
  <li>
    <p>The WinXP installation must be <strong>a guest OS in VirtualBox with working Direct3D acceleration</strong>. It would not work if your VirtualBox version does not support Direct3D acceleration for WinXP guest OS.</p>
  </li>
</ul>

<h2 id="part-1-copy-related-dll-files">Part 1: Copy related DLL files</h2>

<p>First, you need to copy related DLL files from WinXP guest OS.</p>

<p>For v5.0.10.r104061, they are</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>- d3d8.dll
- d3d9.dll
- VBoxD3D8.dll
- VBoxD3D9.dll
- VBoxOGL.dll
- VBoxOGLarrayspu.dll
- VBoxOGLcrutil.dll
- VBoxOGLerrorspu.dll
- VBoxOGLfeedbackspu.dll
- VBoxOGLpackspu.dll
- VBoxOGLpassthroughspu.dll
- wined3d.dll
</code></pre></div></div>

<p>For v5.2.44.r139111, they are</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>- d3d8.dll
- d3d9.dll
- VBoxD3D8.dll
- VBoxD3D9.dll
- VBoxOGL.dll
- wined3d.dll
</code></pre></div></div>

<h2 id="part-2-mod-related-dll-files-to-load-kernel31dll-instead">Part 2: Mod related DLL files to load kernel31.dll instead</h2>

<ul>
  <li>
    <p>Some <code class="language-plaintext highlighter-rouge">kernel32</code> APIs required by these DLL files are only present on WinXP.</p>
  </li>
  <li>
    <p>To make them work on Win2000, we need to mod them to load alternative DLL instead, which I named as <code class="language-plaintext highlighter-rouge">kernel31.dll</code>. It forwards most API calls to the real <code class="language-plaintext highlighter-rouge">kernel32.dll</code>, and provides stub for APIs that are not supported by Win2000.</p>
  </li>
  <li>
    <p>If you are interested in creating such DLL by yourself, you may refer Part X. Otherwise, please refer text below.</p>
  </li>
</ul>

<h3 id="download-kernel31dll-to-win2000-guest-cwinntsystem32">Download <code class="language-plaintext highlighter-rouge">kernel31.dll</code> to Win2000 guest <code class="language-plaintext highlighter-rouge">C:\WINNT\System32</code></h3>

<p>For v5.0.10.r104061, please <a href="/myblog/assets/posts/enable-direct3d-in-win2k-vbox/Kernel31.7z">use this</a>.</p>

<p>For v5.2.44.r139111, please <a href="https://github.com/Raymai97/vbox-d3d-on-w2k/releases/download/20210825.1/kernel31.zip">use this</a>.</p>

<h3 id="mod-dll-file">Mod DLL file</h3>

<p>To mod DLL file, you need a hex editor. I recommend <a href="https://mh-nexus.de/en/hxd/">HxD</a> as it is free, small and serves the purpose well.</p>

<ol>
  <li>Open the file with hex editor.</li>
  <li>Search (Ctrl+F) for text-string <code class="language-plaintext highlighter-rouge">kernel32.dll</code>.<br />
Be careful. Sometimes there are more than one occurence in a file.
    <ul>
      <li>This is the <code class="language-plaintext highlighter-rouge">kernel32.dll</code> we are looking for:
  <img src="/myblog/assets/posts/enable-direct3d-in-win2k-vbox/true-kernel32-string.png" alt="img" /></li>
      <li>This is <strong>NOT</strong> the one we are looking for:<br />
  <img src="/myblog/assets/posts/enable-direct3d-in-win2k-vbox/false-kernel32-string.png" alt="img" /></li>
    </ul>
  </li>
  <li>Overwrite so it become <code class="language-plaintext highlighter-rouge">kernel31.dll</code> and save the file.<br />
<img src="/myblog/assets/posts/enable-direct3d-in-win2k-vbox/overwrite-like-this.png" alt="img" /></li>
</ol>

<h2 id="part-3-configure-your-win2000-guest-os">Part 3: Configure your Win2000 guest OS</h2>

<p>Checklist:</p>
<ul>
  <li>Install VirtualBox Guest Addition as usual.<br />
No need to tick “Direct3D Support”.</li>
  <li>Install DirectX 9.0 redist.<br />
If you hit issue, try older version such as “DirectX 9.0c (Dec 2006)”.</li>
  <li>Copy the related DLL files to <code class="language-plaintext highlighter-rouge">C:\WINNT\System32</code>.<br />
You may want to backup the original files to somewhere before overwriting them.</li>
  <li>Open your guest OS settings, go to Display and
    <ul>
      <li>Tick “Enable 3D Acceleration”</li>
      <li>Set video memory to 128MB
<img src="/myblog/assets/posts/enable-direct3d-in-win2k-vbox/vm-cfg-enable-d3d.png" alt="img" /></li>
    </ul>
  </li>
</ul>

<p>Finally, run <code class="language-plaintext highlighter-rouge">dxdiag</code> to see if the Direct3D acceleration is working.<br />
It is expected to fail in Direct3D 7, but succeed in Direct3D 8 and 9 test.</p>

<p>Here is the result:
<img src="/myblog/assets/posts/enable-direct3d-in-win2k-vbox/result.png" alt="img" /></p>

<h2 id="part-x-creating-the-kernel31dll">Part X: Creating the Kernel31.dll</h2>

<p>If you read this, I assume you already know how to create a DLL and export C functions. Here I’m just going to list out the important points. For complete source code, please refer to my <a href="https://github.com/Raymai97/vbox-d3d-on-w2k">repo</a>.</p>

<ul>
  <li>
    <p>First, find out what <code class="language-plaintext highlighter-rouge">kernel32</code> APIs are needed by the related DLLs.</p>
  </li>
  <li>
    <p>Then, find out what <code class="language-plaintext highlighter-rouge">kernel32</code> APIs are already available in Win2000.</p>
  </li>
  <li>For APIs that are already available in Win2000, you just need to forward API calls.<br />
To forward API calls, use pragma to instruct the linker to do so.<br />
For example, if the API name is <code class="language-plaintext highlighter-rouge">AddVectoredExceptionHandler</code>, you write the pragma like this:
    <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#pragma comment(linker, "/export:AddVectoredExceptionHandler=kernel32.AddVectoredExceptionHandler")
</span></code></pre></div>    </div>
    <p>to forward the API call to the real <code class="language-plaintext highlighter-rouge">kernel32.dll</code>.</p>
  </li>
  <li>For APIs that are required but not available in Win2000, you need to write the function yourself.<br />
Then, forward the API call to your own exported function, with pragma like this:
    <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#pragma comment(linker, "/export:AddVectoredExceptionHandler=kernel31.My_AddVectoredExceptionHandler")
</span></code></pre></div>    </div>
    <p>And remember to export the function you specified. In this example, it is <code class="language-plaintext highlighter-rouge">My_AddVectoredExceptionHandler</code>.</p>
  </li>
  <li>Make sure you use .def file, or the exported symbol will be decorated and your DLL wouldn’t work.</li>
</ul>

<p><img src="/myblog/assets/posts/enable-direct3d-in-win2k-vbox/bad-example.png" alt="img" />
<img src="/myblog/assets/posts/enable-direct3d-in-win2k-vbox/good-example.png" alt="img" /></p>

<p>Pro Tips:</p>
<ul>
  <li>To build a lean DLL for Win2000, try older MSVC such as “Visual C++ 5.0”.</li>
  <li>Use Dumpbin to get the EXPORTS and IMPORTS of DLL.<br />
IMPORTS let you know what APIs are needed by a DLL.<br />
EXPORTS let you know what APIs are provided by a DLL.</li>
</ul>

  </div><a class="u-url" href="/myblog/enable-direct3d-in-win2k-vbox" hidden></a>
</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/myblog/"></data>

  <div class="wrapper">

    <h2 class="footer-heading">myblog - raymai97</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li class="p-name">myblog - raymai97</li><li><a class="u-email" href="mailto:cheeboonray@gmail.com">cheeboonray@gmail.com</a></li></ul>
      </div>

      <div class="footer-col footer-col-2"><ul class="social-media-list"><li><a href="https://github.com/raymai97"><svg class="svg-icon"><use xlink:href="/myblog/assets/minima-social-icons.svg#github"></use></svg> <span class="username">raymai97</span></a></li><li><a href="https://www.twitter.com/raymai97"><svg class="svg-icon"><use xlink:href="/myblog/assets/minima-social-icons.svg#twitter"></use></svg> <span class="username">raymai97</span></a></li></ul>
</div>

      <div class="footer-col footer-col-3">
        <p>A general blog sharing stuff about Windows, Visual Studio, Programming, Anime, Games and anything from my thought.
</p>
      </div>
    </div>

  </div>

</footer>
</body>

</html>
