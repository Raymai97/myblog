<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Enable Direct3D acceleration in Windows 2000 in VirtualBox</title>
  <meta name="description" content="VBox version: v5.0.10.r104061">

  <link rel="stylesheet" href="/myblog/assets/main.css">
  <link rel="canonical" href="https://raymai97.github.io/myblog/enable-direct3d-in-win2k-vbox">
  <link rel="alternate" type="application/rss+xml" title="myblog - raymai97" href="/myblog/feed.xml">
  
  
  
  <!-- Begin Jekyll SEO tag v2.7.1 -->
<title>Enable Direct3D acceleration in Windows 2000 in VirtualBox | myblog - raymai97</title>
<meta name="generator" content="Jekyll v4.2.0" />
<meta property="og:title" content="Enable Direct3D acceleration in Windows 2000 in VirtualBox" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="VBox version: v5.0.10.r104061" />
<meta property="og:description" content="VBox version: v5.0.10.r104061" />
<link rel="canonical" href="https://raymai97.github.io/myblog/enable-direct3d-in-win2k-vbox" />
<meta property="og:url" content="https://raymai97.github.io/myblog/enable-direct3d-in-win2k-vbox" />
<meta property="og:site_name" content="myblog - raymai97" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2017-05-03T15:34:00+08:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Enable Direct3D acceleration in Windows 2000 in VirtualBox" />
<script type="application/ld+json">
{"@type":"BlogPosting","headline":"Enable Direct3D acceleration in Windows 2000 in VirtualBox","dateModified":"2017-05-03T15:34:00+08:00","datePublished":"2017-05-03T15:34:00+08:00","description":"VBox version: v5.0.10.r104061","url":"https://raymai97.github.io/myblog/enable-direct3d-in-win2k-vbox","mainEntityOfPage":{"@type":"WebPage","@id":"https://raymai97.github.io/myblog/enable-direct3d-in-win2k-vbox"},"@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->

</head>
<body><header class="site-header" role="banner">

  <div class="wrapper"><a class="site-title" rel="author" href="/myblog/">myblog - raymai97</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/myblog/about/">About</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Enable Direct3D acceleration in Windows 2000 in VirtualBox</h1>
    <p class="post-meta">
      <time class="dt-published" datetime="2017-05-03T15:34:00+08:00" itemprop="datePublished">May 3, 2017
      </time></p>
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    <p>VBox version: v5.0.10.r104061</p>

<h2 id="part-1-obtaining-required-files">Part 1: Obtaining required files</h2>

<p>First, you must need to obtain these files:</p>
<ul>
  <li>d3d8.dll</li>
  <li>d3d9.dll</li>
  <li>VBoxD3D8.dll</li>
  <li>VBoxD3D9.dll</li>
  <li>VBoxOGL.dll</li>
  <li>VBoxOGLarrayspu.dll</li>
  <li>VBoxOGLcrutil.dll</li>
  <li>VBoxOGLerrorspu.dll</li>
  <li>VBoxOGLfeedbackspu.dll</li>
  <li>VBoxOGLpackspu.dll</li>
  <li>VBoxOGLpassthroughspu.dll</li>
  <li>wined3d.dll</li>
</ul>

<p>I get these files from my Windows XP guest OS, with Direct3D acceleration enabled.</p>

<h2 id="part-2-mod-the-files-to-load-kernel31dll-instead">Part 2: Mod the files to load kernel31.dll instead</h2>

<blockquote>
  <p>Win2K doesn’t support new APIs introduced in WinXP. In this case, all of these APIs are in kernel32.dll. We need a DLL, say, kernel31.dll, which will forward most of the calls to the real kernel32.dll. For “new” APIs, we will provide implementation by ourselves. Creating such DLL requires some programming knowledge. If you know how to create DLL that exports function, then you may refer Part X. Otherwise, you might just want to <a href="/myblog/assets/posts/enable-direct3d-in-win2k-vbox/Kernel31.7z">download the kernel31.dll here</a>.</p>
</blockquote>

<p>To do this, you need a hex editor. I recommended <a href="https://mh-nexus.de/en/hxd/">HxD</a> as it is free, small and serves the purpose well.</p>

<p>You need to mod the following files:</p>
<ul>
  <li>VBoxD3D8.dll</li>
  <li>VBoxD3D9.dll</li>
  <li>VBoxOGL.dll</li>
  <li>VBoxOGLarrayspu.dll</li>
  <li>VBoxOGLcrutil.dll</li>
  <li>VBoxOGLerrorspu.dll</li>
  <li>VBoxOGLfeedbackspu.dll</li>
  <li>VBoxOGLpackspu.dll</li>
  <li>VBoxOGLpassthroughspu.dll</li>
  <li>wined3d.dll</li>
</ul>

<h3 id="to-mod-a-file">To mod a file:</h3>
<ol>
  <li>Open the file with hex editor.</li>
  <li>Search (Ctrl+F) for text-string <code class="language-plaintext highlighter-rouge">kernel32.dll</code>.<br />
Be careful. Sometimes there are more than one occurence in a file.
    <ul>
      <li>This is the <code class="language-plaintext highlighter-rouge">kernel32.dll</code> we are looking for:
  <img src="/myblog/assets/posts/enable-direct3d-in-win2k-vbox/true-kernel32-string.png" alt="img" /></li>
      <li>This is <strong>NOT</strong> the one we are looking for:<br />
  <img src="/myblog/assets/posts/enable-direct3d-in-win2k-vbox/false-kernel32-string.png" alt="img" /></li>
    </ul>
  </li>
  <li>Overwrite so it become <code class="language-plaintext highlighter-rouge">kernel31.dll</code> and save the file.<br />
<img src="/myblog/assets/posts/enable-direct3d-in-win2k-vbox/overwrite-like-this.png" alt="img" /></li>
</ol>

<h2 id="part-3-showtime">Part 3: Showtime</h2>

<ol>
  <li>If you haven’t install Win2K as guest OS yet, do it now.
    <ul>
      <li>Install VirtualBox Guest Addition as usual.</li>
      <li>No need to tick Direct3D support.</li>
    </ul>
  </li>
  <li>Go to Machine &gt; Settings &gt; Display
    <ul>
      <li>Tick “Enable 3D Acceleration”</li>
      <li>Tick “Enable 2D Video Acceleration”</li>
      <li>Video Memory 128MB</li>
    </ul>
  </li>
  <li>Copy and paste the following files into <code class="language-plaintext highlighter-rouge">C:\WINNT\System32</code> in Win2K.<br />
Overwrite the file if prompted.
    <ul>
      <li>d3d8.dll</li>
      <li>d3d9.dll</li>
      <li>VBoxD3D8.dll</li>
      <li>VBoxD3D9.dll</li>
      <li>VBoxOGL.dll</li>
      <li>VBoxOGLarrayspu.dll</li>
      <li>VBoxOGLcrutil.dll</li>
      <li>VBoxOGLerrorspu.dll</li>
      <li>VBoxOGLfeedbackspu.dll</li>
      <li>VBoxOGLpackspu.dll</li>
      <li>VBoxOGLpassthroughspu.dll</li>
      <li>wined3d.dll</li>
      <li><a href="(/myblog/assets/posts/enable-direct3d-in-win2k-vbox/Kernel31.7z)">Kernel31.dll</a></li>
    </ul>
  </li>
</ol>

<p>4) Finally, run <code class="language-plaintext highlighter-rouge">dxdiag</code> to see if the Direct3D acceleration is working.<br />
It is expected to fail in Direct3D 7, but succeed in Direct3D 8 and 9 test.<br />
Here is a screenshot running Touhou games in Win2k VBox guest:<br />
<img src="/myblog/assets/posts/enable-direct3d-in-win2k-vbox/proof-running-touhou-rss.png" alt="img" /></p>

<h2 id="part-x-creating-the-kernel31dll">Part X: Creating the Kernel31.dll</h2>

<p>When you read this, I assume you already know how to create a DLL and export C function, so I’m just going to key out some tips on creating the DLL.</p>

<ul>
  <li>First, determine a list of <code class="language-plaintext highlighter-rouge">kernel32</code> APIs to be handled.</li>
  <li>You can use Dumpbin to find out what APIs are used by a DLL.</li>
  <li>You should handle all DLLs mentioned in Part 2.</li>
  <li>To forward API calls, write corresponding pragma to instruct the linker about it. For example, if the API name is <code class="language-plaintext highlighter-rouge">AddVectoredExceptionHandler</code>, you write the pragma like this:
    <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#pragma comment(linker, "/export:AddVectoredExceptionHandler=kernel32.AddVectoredExceptionHandler")
</span></code></pre></div>    </div>
    <p>to forward the API call to the real <code class="language-plaintext highlighter-rouge">kernel32.dll</code>.</p>
  </li>
  <li>If you want to provide your own implementation, you forward the API call to your own exported function, with pragma like this:
    <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#pragma comment(linker, "/export:AddVectoredExceptionHandler=kernel31.My_AddVectoredExceptionHandler")
</span></code></pre></div>    </div>
    <p>And remember to export the function you specified. In this example, it is <code class="language-plaintext highlighter-rouge">My_AddVectoredExceptionHandler</code>.</p>
  </li>
  <li>Make sure you use .def file, or the exported symbol will be decorated and your DLL wouldn’t work.</li>
</ul>

<p><img src="/myblog/assets/posts/enable-direct3d-in-win2k-vbox/bad-example.png" alt="img" />
<img src="/myblog/assets/posts/enable-direct3d-in-win2k-vbox/good-example.png" alt="img" /></p>

  </div><a class="u-url" href="/myblog/enable-direct3d-in-win2k-vbox" hidden></a>
</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/myblog/"></data>

  <div class="wrapper">

    <h2 class="footer-heading">myblog - raymai97</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li class="p-name">myblog - raymai97</li><li><a class="u-email" href="mailto:cheeboonray@gmail.com">cheeboonray@gmail.com</a></li></ul>
      </div>

      <div class="footer-col footer-col-2"><ul class="social-media-list"><li><a href="https://github.com/raymai97"><svg class="svg-icon"><use xlink:href="/myblog/assets/minima-social-icons.svg#github"></use></svg> <span class="username">raymai97</span></a></li><li><a href="https://www.twitter.com/raymai97"><svg class="svg-icon"><use xlink:href="/myblog/assets/minima-social-icons.svg#twitter"></use></svg> <span class="username">raymai97</span></a></li></ul>
</div>

      <div class="footer-col footer-col-3">
        <p>A general blog sharing stuff about Windows, Visual Studio, Programming, Anime, Games and anything from my thought.
</p>
      </div>
    </div>

  </div>

</footer>
</body>

</html>
